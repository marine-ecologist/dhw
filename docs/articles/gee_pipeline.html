<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Automated Daily DHW Pipeline • dhw</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="gee_pipeline_files/libs/quarto-html/popper.min.js"></script><script src="gee_pipeline_files/libs/quarto-html/tippy.umd.min.js"></script><link href="gee_pipeline_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="gee_pipeline_files/libs/quarto-html/light-border.css" rel="stylesheet">
<script src="gee_pipeline_files/libs/quarto-diagram/mermaid.min.js"></script><script src="gee_pipeline_files/libs/quarto-diagram/mermaid-init.js"></script><link href="gee_pipeline_files/libs/quarto-diagram/mermaid.css" rel="stylesheet">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Automated Daily DHW Pipeline">
<meta property="og:image" content="https://marine-ecologist.github.io/dhw/logo.png">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">dhw</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.4.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-r" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">R</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-r">
<li><a class="dropdown-item" href="../articles/calculating_climatologies.html">1. Calculating Degree Heating Weeks</a></li>
    <li><a class="dropdown-item" href="../articles/validating_climatologies.html">2. Reproducible Code &amp; validating DHW climatologies</a></li>
    <li><a class="dropdown-item" href="../articles/extracting_data.html">3. Downloading SST and spatial data</a></li>
    <li><a class="dropdown-item" href="../articles/visualising_outputs.html">4. Visualising outputs from dhw</a></li>
    <li><a class="dropdown-item" href="../articles/dhw_extended.html">5. Extending the DHW metric</a></li>
    <li><a class="dropdown-item" href="../articles/hindcast.html">6. Hindcasting DHW records</a></li>
    <li><a class="dropdown-item" href="../articles/changepoint.html">7. Bayesian changepoint detection and DHW</a></li>
  </ul>
</li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-gee" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">GEE</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-gee">
<li><a class="dropdown-item" href="../articles/gee_scripts.html">1. Calculating DHW in Google Earth Engine</a></li>
    <li><a class="dropdown-item" href="../articles/gee_pipeline.html">2. Google Earth Engine pipeline for OISST</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-quarto">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Automated Daily DHW Pipeline</h1>
      <p class="subtitle">Google Earth Engine → Google Cloud Storage via Cloud Functions</p>




      <div class="d-none name"><code></code></div>
    </div>






    <section class="level2"><h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>This document describes an automated pipeline that computes daily coral bleaching heat stress products for the Great Barrier Reef and exports them to Google Cloud Storage (GCS) as Cloud Optimized GeoTIFFs (COGs), with summary statistics logged to BigQuery.</p>
<p>The pipeline implements the same methodology as the interactive GEE scripts (see companion document), following <span class="citation" data-cites="skirving2020">@skirving2020</span>, but runs unattended on a daily schedule via Google Cloud infrastructure.</p>
<section class="level3"><h3 id="architecture">Architecture<a class="anchor" aria-label="anchor" href="#architecture"></a>
</h3>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div id="fig-architecture" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-fig"><div aria-describedby="fig-architecture-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>
<pre class="mermaid mermaid-js" data-label="fig-architecture">flowchart TD
    SCHED[Cloud Scheduler&lt;br/&gt;Daily 12:00 UTC] --&gt;|Pub/Sub| CF[Cloud Function&lt;br/&gt;pipeline/main.py]
    CF --&gt;|ee.batch.Export| GCS[(GCS Bucket&lt;br/&gt;COGs)]
    CF --&gt;|reduceRegion + getInfo| BQ[(BigQuery&lt;br/&gt;daily_summary)]
    CF --&gt;|reads| ASSETS[(EE Assets&lt;br/&gt;MM, MMM, DC)]
    CF --&gt;|reads| OISST[(NOAA OISST&lt;br/&gt;Daily SST)]

    subgraph "Pre-computed once"
        ASSETS
    end

    subgraph "Updated daily"
        OISST
    end

    subgraph "Outputs"
        GCS
        BQ
    end
</pre>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-architecture-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure 1: Pipeline architecture: Cloud Scheduler triggers a Cloud Function daily.
</figcaption></figure>
</div>
</div>
</div>
</section></section><section class="level2"><h2 id="pipeline-components">Pipeline Components<a class="anchor" aria-label="anchor" href="#pipeline-components"></a>
</h2>
<p>The pipeline consists of four Python scripts and one shell deployment script. <strong>No credentials, project IDs, or login details are stored in any script</strong> — all configuration is read from environment variables at runtime.</p>
<div id="tbl-files" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-tbl"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-files-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table 1: Pipeline files and their roles.
</figcaption><div aria-describedby="tbl-files-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="table caption-top" style="width:100%;">
<colgroup>
<col style="width: 28%">
<col style="width: 42%">
<col style="width: 28%">
</colgroup>
<thead><tr class="header">
<th>File</th>
<th>Purpose</th>
<th>Runs</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>precompute_climatology.py</code></td>
<td>Export MM, MMM, DC as EE assets</td>
<td>Once</td>
</tr>
<tr class="even">
<td><code>pipeline/main.py</code></td>
<td>Cloud Function: daily SST, anomaly, DHW</td>
<td>Daily (automated)</td>
</tr>
<tr class="odd">
<td><code>pipeline/requirements.txt</code></td>
<td>Python dependencies for the function</td>
<td>—</td>
</tr>
<tr class="even">
<td><code>backfill.py</code></td>
<td>Process historical date ranges locally</td>
<td>On demand</td>
</tr>
<tr class="odd">
<td><code>deploy.sh</code></td>
<td>Create all GCP resources and deploy</td>
<td>Once</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<section class="level3"><h3 id="environment-variables">Environment Variables<a class="anchor" aria-label="anchor" href="#environment-variables"></a>
</h3>
<p>All scripts read configuration from environment variables. No defaults contain real project IDs or bucket names.</p>
<div id="tbl-envvars" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-tbl"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-envvars-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table 2: Environment variables used by the pipeline.
</figcaption><div aria-describedby="tbl-envvars-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="table caption-top">
<colgroup>
<col style="width: 31%">
<col style="width: 28%">
<col style="width: 40%">
</colgroup>
<thead><tr class="header">
<th>Variable</th>
<th>Used by</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>GEE_PROJECT</code></td>
<td>All</td>
<td>Google Cloud project ID registered with Earth Engine</td>
</tr>
<tr class="even">
<td><code>GCS_BUCKET</code></td>
<td>
<code>main.py</code>, <code>backfill.py</code>, <code>deploy.sh</code>
</td>
<td>GCS bucket name for COG exports</td>
</tr>
<tr class="odd">
<td><code>BQ_TABLE</code></td>
<td><code>main.py</code></td>
<td>BigQuery table (auto-set by <code>deploy.sh</code>)</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section></section><section class="level2"><h2 id="pre-computed-climatology">Pre-computed Climatology<a class="anchor" aria-label="anchor" href="#pre-computed-climatology"></a>
</h2>
<p>The MM, MMM, and 366-day daily climatology are static products derived from the 1985–2012 OISST record. They are computed once by <code>precompute_climatology.py</code> and exported as Earth Engine assets.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">GEE_PROJECT</span><span class="op">=</span><span class="st">"&lt;your-project-id&gt;"</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> precompute_climatology.py</span></code></pre></div>
<p>This creates three assets:</p>
<div id="tbl-assets" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-tbl"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-assets-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table 3: Pre-computed Earth Engine assets.
</figcaption><div aria-describedby="tbl-assets-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="table caption-top">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 48%">
</colgroup>
<thead><tr class="header">
<th>Asset</th>
<th>Bands</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>coral_dhw/mm_climatology</code></td>
<td>12</td>
<td>Monthly mean SST (mm_01 … mm_12)</td>
</tr>
<tr class="even">
<td><code>coral_dhw/mmm_climatology</code></td>
<td>1</td>
<td>Maximum monthly mean SST</td>
</tr>
<tr class="odd">
<td><code>coral_dhw/daily_climatology</code></td>
<td>366</td>
<td>Interpolated daily SST (dc_001 … dc_366)</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>The script polls the EE task queue and reports completion. Typical runtime is 5–15 minutes.</p>
<section class="level3"><h3 id="why-pre-compute">Why Pre-compute?<a class="anchor" aria-label="anchor" href="#why-pre-compute"></a>
</h3>
<p>Loading climatology from assets is effectively instantaneous. Without pre-computation, each daily run would re-derive the climatology from 28 years of data — processing 12 × 28 = 336 monthly means and performing 12 regressions — adding several minutes and significant computation to every invocation.</p>
</section></section><section class="level2"><h2 id="cloud-function-daily-processing">Cloud Function: Daily Processing<a class="anchor" aria-label="anchor" href="#cloud-function-daily-processing"></a>
</h2>
<p><strong>File:</strong> <code>pipeline/main.py</code></p>
<section class="level3"><h3 id="trigger">Trigger<a class="anchor" aria-label="anchor" href="#trigger"></a>
</h3>
<p>The function is triggered by a Pub/Sub message sent by Cloud Scheduler at 12:00 UTC daily. NOAA OISST data typically becomes available by ~09:00 UTC for the previous day, so the function processes <strong>yesterday’s date</strong> by default.</p>
<p>If data is not yet available, the function falls back to the day before.</p>
</section><section class="level3"><h3 id="products-computed">Products Computed<a class="anchor" aria-label="anchor" href="#products-computed"></a>
</h3>
<p>For each day, three gridded products are computed and exported:</p>
<section class="level4"><h4 id="raw-sst">1. Raw SST<a class="anchor" aria-label="anchor" href="#raw-sst"></a>
</h4>
<p>The observed OISST sea surface temperature, scaled from raw integer values to °C and clipped to the ROI:</p>
<p><span class="math display">\[\text{SST} = \text{OISST}_{\text{raw}} \times 0.01\]</span></p>
</section><section class="level4"><h4 id="sst-anomaly">2. SST Anomaly<a class="anchor" aria-label="anchor" href="#sst-anomaly"></a>
</h4>
<p><span class="math display">\[\text{SST Anomaly}_i = \text{SST}_i - \text{DC}_d\]</span></p>
<p>where <span class="math inline">\(d\)</span> is the day-of-year of date <span class="math inline">\(i\)</span>, and <span class="math inline">\(\text{DC}_d\)</span> is the corresponding band from the pre-computed daily climatology asset.</p>
</section><section class="level4"><h4 id="degree-heating-weeks">3. Degree Heating Weeks<a class="anchor" aria-label="anchor" href="#degree-heating-weeks"></a>
</h4>
<p><span class="math display">\[\text{DHW}_i = \sum_{n=i-83}^{i} \frac{\text{HS}_n}{7},
\quad \text{where } \text{HS}_n \geq 1\,°\text{C}\]</span></p>
<p>The function loads 84 days of OISST data, computes the HotSpot for each day (<span class="math inline">\(\text{HS} = \max(\text{SST} - \text{MMM}, 0)\)</span>), thresholds at 1°C, sums, and divides by 7.</p>
</section></section><section class="level3"><h3 id="export-to-gcs">Export to GCS<a class="anchor" aria-label="anchor" href="#export-to-gcs"></a>
</h3>
<p>Each product is exported as a <strong>Cloud Optimized GeoTIFF</strong> via <code>ee.batch.Export.image.toCloudStorage()</code> with <code>cloudOptimized: True</code>.</p>
<p>These exports are <strong>asynchronous</strong> — the Cloud Function starts the EE export tasks (~2 seconds) and returns. GEE’s servers then perform the actual computation and write the files to GCS (typically 1–5 minutes).</p>
<p>GCS file structure:</p>
<pre><code>gs://&lt;bucket&gt;/
  sst/
    2024/
      20240101.tif
      20240102.tif
      ...
  sst_anomaly/
    2024/
      20240101.tif
      ...
  dhw/
    2024/
      20240101.tif
      ...
  annual_max_dhw/
    2024/
      20241231.tif</code></pre>
</section><section class="level3"><h3 id="summary-statistics-to-bigquery">Summary Statistics to BigQuery<a class="anchor" aria-label="anchor" href="#summary-statistics-to-bigquery"></a>
</h3>
<p>The function also computes GBR-wide spatial statistics <strong>synchronously</strong> via <code>ee.Image.reduceRegion()</code> and inserts a single row into BigQuery (~10 seconds).</p>
<p>For each product <span class="math inline">\(X \in \{\text{SST}, \text{Anomaly}, \text{DHW}\}\)</span>:</p>
<ul>
<li>
<strong>Spatial mean</strong>: <span class="math inline">\(\bar{X} = \frac{1}{n}\sum_{p=1}^{n} X_p\)</span>
</li>
<li>
<strong>Standard deviation</strong>: <span class="math inline">\(s_X\)</span>
</li>
<li>
<strong>95% confidence interval on the spatial mean</strong>: <span class="math inline">\(\bar{X} \pm 1.96 \cdot \frac{s_X}{\sqrt{n}}\)</span>
</li>
<li>
<strong>Pixel count</strong>: <span class="math inline">\(n\)</span>
</li>
</ul>
<section class="level4"><h4 id="bigquery-table-schema">BigQuery Table Schema<a class="anchor" aria-label="anchor" href="#bigquery-table-schema"></a>
</h4>
<div id="tbl-schema" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-tbl"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-schema-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table 4: BigQuery <code>daily_summary</code> table schema.
</figcaption><div aria-describedby="tbl-schema-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="table caption-top">
<thead><tr class="header">
<th>Column</th>
<th>Type</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>date</code></td>
<td>DATE</td>
<td>Observation date</td>
</tr>
<tr class="even">
<td><code>sst_mean</code></td>
<td>FLOAT</td>
<td>GBR spatial mean SST (°C)</td>
</tr>
<tr class="odd">
<td><code>sst_std</code></td>
<td>FLOAT</td>
<td>Spatial standard deviation</td>
</tr>
<tr class="even">
<td><code>sst_ci95_lower</code></td>
<td>FLOAT</td>
<td>Lower bound of 95% CI</td>
</tr>
<tr class="odd">
<td><code>sst_ci95_upper</code></td>
<td>FLOAT</td>
<td>Upper bound of 95% CI</td>
</tr>
<tr class="even">
<td><code>sst_n_pixels</code></td>
<td>INTEGER</td>
<td>Number of valid pixels</td>
</tr>
<tr class="odd">
<td><code>anomaly_mean</code></td>
<td>FLOAT</td>
<td>GBR spatial mean anomaly (°C)</td>
</tr>
<tr class="even">
<td><code>anomaly_std</code></td>
<td>FLOAT</td>
<td>Spatial standard deviation</td>
</tr>
<tr class="odd">
<td><code>anomaly_ci95_lower</code></td>
<td>FLOAT</td>
<td>Lower bound of 95% CI</td>
</tr>
<tr class="even">
<td><code>anomaly_ci95_upper</code></td>
<td>FLOAT</td>
<td>Upper bound of 95% CI</td>
</tr>
<tr class="odd">
<td><code>anomaly_n_pixels</code></td>
<td>INTEGER</td>
<td>Number of valid pixels</td>
</tr>
<tr class="even">
<td><code>dhw_mean</code></td>
<td>FLOAT</td>
<td>GBR spatial mean DHW (°C-weeks)</td>
</tr>
<tr class="odd">
<td><code>dhw_std</code></td>
<td>FLOAT</td>
<td>Spatial standard deviation</td>
</tr>
<tr class="even">
<td><code>dhw_ci95_lower</code></td>
<td>FLOAT</td>
<td>Lower bound of 95% CI</td>
</tr>
<tr class="odd">
<td><code>dhw_ci95_upper</code></td>
<td>FLOAT</td>
<td>Upper bound of 95% CI</td>
</tr>
<tr class="even">
<td><code>dhw_n_pixels</code></td>
<td>INTEGER</td>
<td>Number of valid pixels</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section></section><section class="level3"><h3 id="function-execution-timeline">Function Execution Timeline<a class="anchor" aria-label="anchor" href="#function-execution-timeline"></a>
</h3>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div id="fig-timeline" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-fig"><div aria-describedby="fig-timeline-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>
<pre class="mermaid mermaid-js" data-label="fig-timeline">gantt
    title Daily Pipeline Execution
    dateFormat  ss
    axisFormat  %S s

    section Cloud Function
    Init EE + load assets     :a1, 00, 3s
    Compute SST + Anomaly     :a2, after a1, 2s
    Compute DHW (84-day)      :a3, after a2, 3s
    Start 3 export tasks      :a4, after a3, 2s
    Compute + save summary    :a5, after a4, 10s
    Function returns          :milestone, after a5, 0s

    section GEE Backend (async)
    Export SST COG            :b1, after a4, 120s
    Export Anomaly COG        :b2, after a4, 120s
    Export DHW COG            :b3, after a4, 180s
</pre>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-timeline-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure 2: Execution timeline for a single daily run.
</figcaption></figure>
</div>
</div>
</div>
</section></section><section class="level2"><h2 id="backfill-historical-processing">Backfill: Historical Processing<a class="anchor" aria-label="anchor" href="#backfill-historical-processing"></a>
</h2>
<p><strong>File:</strong> <code>backfill.py</code></p>
<p>The backfill script processes a range of historical dates, submitting export tasks to GEE in bulk:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> backfill.py <span class="at">--start</span> 2024-01-01 <span class="at">--end</span> 2024-12-31 <span class="at">--dest</span> gcs</span></code></pre></div>
<p>It also supports computing the annual maximum DHW (per-pixel):</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> backfill.py <span class="at">--annual-max</span> 2024 <span class="at">--dest</span> gcs</span></code></pre></div>
<section class="level3"><h3 id="rate-limiting">Rate Limiting<a class="anchor" aria-label="anchor" href="#rate-limiting"></a>
</h3>
<p>GEE allows up to ~3,000 concurrent queued export tasks. The backfill script pauses briefly every 50 dates to avoid hitting API rate limits. A full year (365 days × 3 products = 1,095 tasks) completes in a few minutes of task submission, with GEE processing the exports over 1–2 hours.</p>
</section></section><section class="level2"><h2 id="deployment">Deployment<a class="anchor" aria-label="anchor" href="#deployment"></a>
</h2>
<p><strong>File:</strong> <code>deploy.sh</code></p>
<p>The deployment script creates all required GCP resources:</p>
<ol type="1">
<li>
<strong>Enables APIs</strong> — Earth Engine, Cloud Functions, Cloud Scheduler, Pub/Sub, BigQuery, Cloud Storage, Cloud Build, Cloud Run</li>
<li>
<strong>Creates a service account</strong> with roles:
<ul>
<li><code>roles/earthengine.admin</code></li>
<li><code>roles/storage.objectAdmin</code></li>
<li><code>roles/bigquery.dataEditor</code></li>
<li><code>roles/bigquery.jobUser</code></li>
</ul>
</li>
<li>
<strong>Creates the GCS bucket</strong> in <code>australia-southeast1</code>
</li>
<li><strong>Creates the BigQuery dataset and table</strong></li>
<li>
<strong>Creates a Pub/Sub topic</strong> for the scheduler trigger</li>
<li>
<strong>Deploys the Cloud Function</strong> (gen2, Python 3.11, 512 MB, 300s timeout)</li>
<li>
<strong>Creates the Cloud Scheduler job</strong> (daily at 12:00 UTC)</li>
</ol>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">GEE_PROJECT</span><span class="op">=</span><span class="st">"&lt;your-project-id&gt;"</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">GCS_BUCKET</span><span class="op">=</span><span class="st">"&lt;your-bucket-name&gt;"</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x deploy.sh</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="ex">./deploy.sh</span></span></code></pre></div>
<section class="level3"><h3 id="prerequisites">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h3>
<ul>
<li>Google Cloud project with billing enabled</li>
<li>
<code>gcloud</code> CLI installed and authenticated</li>
<li>Earth Engine API enabled for the project</li>
<li>Service account registered with Earth Engine</li>
</ul></section></section><section class="level2"><h2 id="cost-estimate">Cost Estimate<a class="anchor" aria-label="anchor" href="#cost-estimate"></a>
</h2>
<section class="level3"><h3 id="data-volume">Data Volume<a class="anchor" aria-label="anchor" href="#data-volume"></a>
</h3>
<p>The GBR ROI at 0.25° resolution contains approximately:</p>
<p><span class="math display">\[\frac{12.1°}{0.25°} \times \frac{15.8°}{0.25°} \approx 48 \times 63
= 3{,}024 \text{ pixels}\]</span></p>
<p>A single-band float32 COG with 3,024 pixels is approximately <strong>15 KB</strong>.</p>
<div id="tbl-volume" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-tbl"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-volume-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table 5: Annual data volume for the GBR ROI.
</figcaption><div aria-describedby="tbl-volume-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="table caption-top">
<thead><tr class="header">
<th>Item</th>
<th>Calculation</th>
<th>Annual total</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Daily COGs</td>
<td>3 products × 15 KB × 365 days</td>
<td>~16 MB</td>
</tr>
<tr class="even">
<td>BigQuery rows</td>
<td>365 rows × ~0.5 KB</td>
<td>~180 KB</td>
</tr>
<tr class="odd">
<td>Annual max DHW</td>
<td>1 COG</td>
<td>~15 KB</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section><section class="level3"><h3 id="monthly-cost">Monthly Cost<a class="anchor" aria-label="anchor" href="#monthly-cost"></a>
</h3>
<div id="tbl-cost" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-tbl"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-cost-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table 6: Estimated monthly costs (all within free tiers).
</figcaption><div aria-describedby="tbl-cost-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="table caption-top">
<thead><tr class="header">
<th>Service</th>
<th>Free tier</th>
<th>Pipeline usage</th>
<th>Cost</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>GCS storage</td>
<td>5 GB</td>
<td>~16 MB/year</td>
<td>$0</td>
</tr>
<tr class="even">
<td>GCS operations</td>
<td>5,000 Class A/month</td>
<td>~90 writes/month</td>
<td>$0</td>
</tr>
<tr class="odd">
<td>BigQuery storage</td>
<td>10 GB</td>
<td>~180 KB/year</td>
<td>$0</td>
</tr>
<tr class="even">
<td>BigQuery queries</td>
<td>1 TB/month</td>
<td>Minimal</td>
<td>$0</td>
</tr>
<tr class="odd">
<td>Cloud Functions</td>
<td>2M invocations/month</td>
<td>30 runs</td>
<td>$0</td>
</tr>
<tr class="even">
<td>Cloud Scheduler</td>
<td>3 free jobs</td>
<td>1 job</td>
<td>$0</td>
</tr>
<tr class="odd">
<td>Pub/Sub</td>
<td>10 GB/month</td>
<td>~30 KB/month</td>
<td>$0</td>
</tr>
<tr class="even">
<td>Earth Engine</td>
<td>Free (non-commercial)</td>
<td>30 computations/month</td>
<td>$0</td>
</tr>
<tr class="odd">
<td><strong>Total</strong></td>
<td></td>
<td></td>
<td><strong>$0/month</strong></td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section></section><section class="level2"><h2 id="serving-outputs">Serving Outputs<a class="anchor" aria-label="anchor" href="#serving-outputs"></a>
</h2>
<p>The COGs stored in GCS can be consumed by mapping applications:</p>
<section class="level3"><h3 id="cesium-web-maps">Cesium / Web Maps<a class="anchor" aria-label="anchor" href="#cesium-web-maps"></a>
</h3>
<p>Use a tile server such as <a href="https://developmentseed.org/titiler/" class="external-link">TiTiler</a> to serve XYZ tiles from the COGs:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example TiTiler URL</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>GET <span class="op">/</span>cog<span class="op">/</span>tiles<span class="op">/</span>{z}<span class="op">/</span>{x}<span class="op">/</span>{y}?url<span class="op">=</span>gs:<span class="op">//</span>bucket<span class="op">/</span>dhw<span class="op">/</span><span class="dv">2024</span><span class="op">/</span><span class="fl">20240315.</span><span class="er">tif</span></span></code></pre></div>
</section><section class="level3"><h3 id="gee-tile-api">GEE Tile API<a class="anchor" aria-label="anchor" href="#gee-tile-api"></a>
</h3>
<p>For live-computed layers (e.g., current DHW), use <code>ee.data.getMapId()</code> to generate tile URLs that can be fed to <code>Cesium.UrlTemplateImageryProvider</code>.</p>
</section><section class="level3"><h3 id="direct-access">Direct Access<a class="anchor" aria-label="anchor" href="#direct-access"></a>
</h3>
<p>COGs in GCS support HTTP range requests, so desktop GIS applications (QGIS, ArcGIS) can open them directly via the <code>gs://</code> or <code>https://storage.googleapis.com/</code> URL without downloading the entire file.</p>
</section></section><section class="level2"><h2 id="monitoring">Monitoring<a class="anchor" aria-label="anchor" href="#monitoring"></a>
</h2>
<section class="level3"><h3 id="check-pipeline-status">Check Pipeline Status<a class="anchor" aria-label="anchor" href="#check-pipeline-status"></a>
</h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Recent logs</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">gcloud</span> functions logs read daily-dhw-pipeline <span class="dt">\</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--region</span><span class="op">=</span>australia-southeast1 <span class="at">--limit</span><span class="op">=</span>20</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Exported files</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="ex">gsutil</span> ls gs://<span class="op">&lt;</span>bucket<span class="op">&gt;</span>/dhw/2024/</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Latest BigQuery entry</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="ex">bq</span> query <span class="at">--nouse_legacy_sql</span> <span class="dt">\</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SELECT * FROM coral_dhw.daily_summary ORDER BY date DESC LIMIT 1"</span></span></code></pre></div>
</section><section class="level3"><h3 id="sample-bigquery-queries">Sample BigQuery Queries<a class="anchor" aria-label="anchor" href="#sample-bigquery-queries"></a>
</h3>
<p><strong>Annual maximum DHW (GBR-wide average):</strong></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">EXTRACT</span>(<span class="dt">YEAR</span> <span class="kw">FROM</span> <span class="dt">date</span>) <span class="kw">AS</span> <span class="dt">year</span>,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MAX</span>(dhw_mean) <span class="kw">AS</span> max_dhw,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MAX</span>(dhw_ci95_upper) <span class="kw">AS</span> max_dhw_upper</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> `<span class="op">&lt;</span>project<span class="op">&gt;</span>.coral_dhw.daily_summary`</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dt">year</span> <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">year</span>;</span></code></pre></div>
<p><strong>Days above bleaching thresholds per year:</strong></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">EXTRACT</span>(<span class="dt">YEAR</span> <span class="kw">FROM</span> <span class="dt">date</span>) <span class="kw">AS</span> <span class="dt">year</span>,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  COUNTIF(dhw_mean <span class="op">&gt;=</span> <span class="dv">4</span>) <span class="kw">AS</span> days_warning,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  COUNTIF(dhw_mean <span class="op">&gt;=</span> <span class="dv">8</span>) <span class="kw">AS</span> days_alert2</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> `<span class="op">&lt;</span>project<span class="op">&gt;</span>.coral_dhw.daily_summary`</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dt">year</span> <span class="kw">ORDER</span> <span class="kw">BY</span> <span class="dt">year</span>;</span></code></pre></div>
</section></section><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'light-border',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config);
    }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script></main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/marine.ecologist/" class="external-link">George Roff</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
