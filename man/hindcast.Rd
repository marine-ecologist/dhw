% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/hindcast.R
\name{hindcast}
\alias{hindcast}
\title{Hindcast Bias-Corrected Raster Time Series via Monthly Anomaly Quantile Mapping (QM/QDM)}
\usage{
hindcast(
  input1,
  input2,
  n_quantiles = 100,
  method = c("qm", "qdm"),
  overlap_period = NULL,
  combine = TRUE,
  filename = NULL,
  overwrite = TRUE,
  wopt = list(datatype = "FLT4S", gdal = c("COMPRESS=LZW")),
  min_n = 10,
  verbose = TRUE,
  silent = TRUE
)
}
\arguments{
\item{input1}{terra::SpatRaster
Reference (observed) raster with the \strong{shorter} time series. Must have a valid
Date vector set via \code{terra::time(input1)}.}

\item{input2}{terra::SpatRaster
Model raster with the \strong{longer} time series extending earlier than \code{input1}.
Must have a valid Date vector set via \code{terra::time(input2)}.}

\item{n_quantiles}{integer
Number of quantiles used for mapping (default \code{100}). Typical range: \code{50} to \code{200}.}

\item{method}{character
Bias-correction method, one of:
\describe{
\item{"qm"}{Quantile Mapping on anomalies (distribution matching).}
\item{"qdm"}{Quantile Delta Mapping (Cannon-style) on anomalies; preserves model anomaly changes.}
}}

\item{overlap_period}{character vector of length 2 or \code{NULL}
Optional calibration window \code{c(start_date, end_date)} in \code{"YYYY-MM-DD"} format.
If \code{NULL} (default), the full overlap is used.}

\item{combine}{logical
If \code{TRUE} (default), returns a continuous raster combining the hindcast period
with the original observed data, ordered by time. If \code{FALSE}, returns only the hindcast period.}

\item{filename}{character or \code{NULL}
Output filename for the raster. If \code{NULL} (default), returns a raster in memory.}

\item{overwrite}{logical
Overwrite an existing file if \code{TRUE} (default).}

\item{wopt}{list
Write options passed to \code{terra::writeRaster()}. Defaults to float storage with LZW compression:
\code{list(datatype = "FLT4S", gdal = c("COMPRESS=LZW"))}.}

\item{min_n}{integer
Minimum number of non-\code{NA} observations per \strong{month} and \strong{cell} required during the
calibration period to perform mapping (default \code{10}). Months/cells failing this remain \code{NA}.}

\item{verbose}{logical
If \code{TRUE} (default), prints progress messages unless \code{silent = TRUE}.}

\item{silent}{logical
If \code{TRUE} (default), suppresses messages regardless of \code{verbose}.}
}
\value{
terra::SpatRaster
Bias-corrected hindcast raster. If \code{combine = TRUE}, spans from the earliest date in \code{input2}
through the latest date in \code{input1}. If \code{combine = FALSE}, spans only the hindcast period.
}
\description{
Reconstructs (hindcasts) an extended raster time series by bias-correcting a long
model dataset against a shorter observed/reference dataset using \strong{monthly anomaly
Quantile Mapping (QM)} or \strong{Quantile Delta Mapping (QDM; Cannon-style)}.
}
\details{
This implementation operates \strong{per grid cell}, applies corrections
\strong{independently for each calendar month}, and performs computations \strong{in memory}
to avoid block-wise I/O workflows.

\itemize{
\item Correction is independent for each grid cell and calendar month.
\item Monthly climatologies are computed only from the calibration overlap.
\item Cells/months with insufficient calibration data (\code{min_n}) remain \code{NA}.
\item All raster values for calibration and hindcast periods are read into memory; large domains may require substantial RAM.
\item The \code{filename} write uses a temporary file then renames, to avoid "source and target are the same" issues.
}
}
\section{Conceptual workflow}{

\enumerate{
\item Align \code{input2} to \code{input1} (resample) if geometries differ.
\item Identify a calibration period from overlapping dates (optionally constrained by \code{overlap_period}).
\item For each grid cell and month:
\enumerate{
\item Compute monthly climatologies over the calibration overlap for observed and model.
\item Convert calibration series to monthly anomalies (value minus monthly climatology).
\item Convert hindcast (pre-observed) model values to anomalies (minus model monthly climatology).
\item Apply either:
\itemize{
\item \strong{QM}: map model-historical anomaly distribution to observed anomaly distribution.
\item \strong{QDM}: preserve model hindcast anomaly changes by adding the model delta at the same quantile:
\deqn{\hat{y} = F_{obs}^{-1}(\tau) + \left(x - F_{mod,hist}^{-1}(\tau)\right), \;\; \tau = F_{mod,proj}(x)}
}
\item Reconstruct absolute values using observed monthly climatology.
}
\item Optionally concatenate the hindcast with the original observed series.
}

Working in anomaly space preserves the seasonal cycle and reduces variance inflation
often seen when mapping absolute values directly.
}

\examples{
\dontrun{
library(terra)

obs <- rast("GBR_OISST_SST.tif")  # observed shorter series
mod <- rast("GBR_ERA5_SST.tif")   # model longer series (extends earlier)

# QM hindcast (in memory)
out_qm <- hindcast_qm2(
  input1 = obs,
  input2 = mod,
  method = "qm",
  n_quantiles = 100,
  overlap_period = c("1982-01-01", "2025-12-31"),
  combine = TRUE,
  filename = NULL
)

# QDM hindcast (write to disk)
out_qdm <- hindcast_qm2(
  input1 = obs,
  input2 = mod,
  method = "qdm",
  n_quantiles = 100,
  overlap_period = c("1982-01-01", "2025-12-31"),
  combine = TRUE,
  filename = "GBR_OISST2_SST_anomQDM_month.tif",
  overwrite = TRUE
)
}

}
\references{
Cannon, A. J., Sobie, S. R., & Murdock, T. Q. (2015).
Bias correction of GCM precipitation by quantile mapping: How well do methods preserve changes in quantiles and extremes?
\emph{Journal of Climate}, 28(17), 6938–6959.

Cannon, A. J. (2015).
Selecting GCM scenarios that span the range of changes in a multimodel ensemble.
\emph{Journal of Climate}, 28(3), 1260–1267.
}
