% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/hindcast_qm.R
\name{hindcast_qm}
\alias{hindcast_qm}
\title{Hindcast Bias-Corrected Raster Time Series via Monthly Anomaly Quantile Mapping}
\usage{
hindcast_qm(
  input1,
  input2,
  n_quantiles = 100,
  method = c("qm", "qdm"),
  overlap_period = NULL,
  combine = TRUE,
  filename = NULL,
  overwrite = TRUE,
  wopt = list(datatype = "FLT4S", gdal = c("COMPRESS=LZW")),
  min_n = 10,
  verbose = TRUE
)
}
\arguments{
\item{input1}{terra::SpatRaster
Reference (observed) raster with the \strong{shorter} time series.
Must have a valid Date vector set via \code{terra::time(input1)}.}

\item{input2}{terra::SpatRaster
Model raster with the \strong{longer} time series extending earlier than \code{input1}.
Must have a valid Date vector set via \code{terra::time(input2)}.}

\item{n_quantiles}{integer
Number of quantiles used for mapping (default = 100).
Typical values range from 50 to 200.}

\item{method}{character
Bias-correction method. One of:
\describe{
\item{"qm"}{Quantile Mapping on anomalies (distribution matching).}
\item{"qdm"}{Quantile Delta Mapping; preserves model anomaly changes.}
}}

\item{overlap_period}{character vector of length 2 or NULL
Optional calibration window \code{c(start_date, end_date)} in \code{"YYYY-MM-DD"} format.
If NULL (default), the full overlapping period is used.}

\item{combine}{logical
If TRUE (default), returns a continuous raster combining the hindcast period
with the original observed data, ordered by time.
If FALSE, returns only the hindcast period.}

\item{filename}{character or NULL
Output filename for the hindcast raster.
If NULL, the raster is returned in memory without writing to disk.}

\item{overwrite}{logical
Overwrite an existing file if TRUE (default).}

\item{wopt}{list
Write options passed to \code{terra::writeRaster()}.
Defaults to floating-point storage with LZW compression.}

\item{min_n}{integer
Minimum number of non-NA observations per month required during the
calibration period to perform quantile mapping (default = 10).}

\item{verbose}{logical
If TRUE (default), prints progress and diagnostic information.}
}
\value{
terra::SpatRaster
Bias-corrected hindcast raster. If \code{combine = TRUE}, the output spans from
the earliest date in \code{input2} through the latest date in \code{input1}.
}
\description{
Reconstructs (hindcasts) an extended raster time series by bias-correcting a
long model dataset against a shorter observed/reference dataset using
\strong{monthly anomaly Quantile Mapping (QM)} or \strong{Quantile Delta Mapping (QDM)}.
}
\details{
This implementation operates \strong{per grid cell}, applies corrections
\strong{independently for each calendar month}, and performs all computations
\strong{in memory} to avoid known I/O limitations in recent versions of \code{terra}
when using block-wise \code{writeStart()} workflows.
\subsection{Conceptual workflow}{

\enumerate{
\item Spatially aligns \code{input2} to \code{input1} if geometries differ.
\item Identifies a calibration period from overlapping dates.
\item Computes monthly climatologies from the calibration period.
\item Converts both datasets to monthly anomalies.
\item Applies QM or QDM to anomalies for each month and grid cell.
\item Reconstructs absolute values using observed climatologies.
\item Optionally concatenates the hindcast with observed data.
}

Working in anomaly space preserves the seasonal cycle and avoids the
variance inflation often seen in raw quantile mapping of absolute values.

\itemize{
\item Correction is applied independently to each grid cell.
\item Monthly climatologies are computed only from the calibration overlap.
\item Cells or months with insufficient calibration data remain NA.
\item All raster values are read into memory; large domains may require
substantial RAM.
}
}
}
\note{
\itemize{
\item Both rasters must share a compatible CRS after alignment.
\item Time vectors must be strictly increasing.
\item For daily (DOY-based) correction, monthly binning would need to be
replaced with day-of-year bins.
}
}
\references{
Cannon, A. J., Sobie, S. R., & Murdock, T. Q. (2015).
Bias correction of GCM precipitation by quantile mapping:
How well do methods preserve changes in quantiles and extremes?
\emph{Journal of Climate}, 28(17), 6938–6959.

Cannon, A. J. (2015).
Selecting GCM scenarios that span the range of changes in a multimodel ensemble.
\emph{Journal of Climate}, 28(3), 1260–1267.
}
