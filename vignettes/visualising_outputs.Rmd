---
title: "Visualising DHW outputs"
author: "George Roff"
date: "2025-09-03"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Validating DHW climatologies}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

`dhw` has several built-in functions for visualising timeseries outputs.

Example outputs from Ningaloo Reef data:

```{r fig.height=4, fig.width=9, message=FALSE, warning=FALSE}
library(terra)
library(tidyverse)
library(dhw)
library(sf)
library(tmap)
library(rnaturalearth)
library(patchwork)


# read raster from package, calculate climatology
ningaloo_OISST <- system.file("extdata", "ningaloo_OISST.tif", package = "dhw", mustWork = TRUE) |> rast()
all_climatology <- create_climatology(ningaloo_OISST, baa = TRUE, quiet=TRUE)

# Example site at Ningaloo for timeseries:
ningaloo_pt <- st_point(c(113.926, -21.92)) |>
  st_sfc(crs = 4326) |>
  st_transform(terra::crs(r)) |>
  st_buffer(0.01)

ningaloo_slope_OISST <- crop(ningaloo_OISST, vect(ningaloo_pt))
ningaloo_climatology <- create_climatology(ningaloo_slope_OISST, baa = TRUE, quiet=TRUE)

```

# Timeseries plots

### Plot maximum annual DHW:

plot a `NOAA`esque annual time-series of sst with Mean Monthly Maximum and Bleaching Alert Levels from the main climatology input:

```{r fig.height=6, fig.width=8, message=FALSE, warning=FALSE}

plot_sst_timeseries(ningaloo_climatology, 2025)

```
note - dhw uses the revised bleaching alert levels 1 to 5:

```{r}

# old alert levels
dplyr::case_when(
  is.na(hotspots) | is.na(dhw)            ~ NA_character_,
  hotspots <= 0                           ~ "No Stress",
  hotspots > 0 & hotspots < 1             ~ "Watch",
  hotspots >= 1 & dhw < 4                 ~ "Warning",
  dhw >= 4 & dhw < 8                      ~ "Alert Level 1",
  dhw >= 8                                ~ "Alert Level 2"
)

# new revised alert levels
dplyr::case_when(
  is.na(hotspots) | is.na(dhw)                 ~ NA_character_,
  hotspots <= 0                                 ~ "No Stress",
  hotspots > 0  & hotspots < 1  & dhw < 4       ~ "Watch",
  hotspots >= 1 & dhw < 4                       ~ "Warning",
  hotspots >= 1 & dhw >= 4  & dhw < 8           ~ "Alert Level 1",
  hotspots >= 1 & dhw >= 8  & dhw < 12          ~ "Alert Level 2",
  hotspots >= 1 & dhw >= 12 & dhw < 16          ~ "Alert Level 3",
  hotspots >= 1 & dhw >= 16 & dhw < 20          ~ "Alert Level 4",
  hotspots >= 1 & dhw >= 20                     ~ "Alert Level 5"
)

```

### Plot maximum annual DHW:

Plot maximum annual DHW from `spatraster` input:

```{r fig.height=6, fig.width=8, message=FALSE, warning=FALSE}

plot_max_dhw(ningaloo_climatology$dhw)

```


### Plot annual DHW timeseries:


Plot annual DHW timeseries from `spatraster` input:

```{r fig.height=6, fig.width=8, message=FALSE, warning=FALSE}

plot_annual_DHW(ningaloo_climatology$dhw)

```

### XY Plot 

Simple base `R` xy plot for two timeseries (mostly for diagnostics):

```{r fig.height=5, fig.width=5, message=FALSE, warning=FALSE}

plot2(ningaloo_climatology$sst, ningaloo_climatology$dhw)

```

### Plot mean monthly SST:

Plot mean monthly SST for a lon/lat from an input sst `spatraster`:

```{r fig.height=7, fig.width=9, message=FALSE, warning=FALSE}

plot_mm(ningaloo_climatology$sst, lon=113.8, lat=-21.9)

```


# Spatial maps 

Spatial maps of DHW for select dates:

```{r fig.height=6, fig.width=8, message=FALSE, warning=FALSE}

# extract dates from climatology
dates <- c("2024-03-22", "2025-04-04")
idx <- match(dates, names(all_climatology$dhw))
ningaloo_subset <- all_climatology$dhw[[idx[!is.na(idx)]]]


# get rNaturalEarth data
aus <- rnaturalearth::ne_countries(country="Australia", scale=10)

# map with tmap
tm_basemap("Esri.WorldImagery", alpha=0.4) +
tm_shape(aus, bbox=st_bbox(ningaloo_subset)) + 
  tm_lines() +
tm_shape(ningaloo_subset, bbox=st_bbox(ningaloo_subset)) +
  tm_raster(col_alpha = 0.5,
            col.scale = tm_scale_continuous(limits=c(0,26), values="-brewer.spectral"), 
            col.free=FALSE,
            col.legend = tm_legend(title="DHW", orientation = "landscape")) 


```

